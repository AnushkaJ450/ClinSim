# MAIN FUNCTION
#####################################################################
wpower <- function(theta, alpha = 0.05, power = 0.80, k = 1,
p1 = NULL, p2 = NULL, p3 = NULL,
rdist = rnorm,
pilot_x = NULL, pilot_y = NULL,
alternative = "two.sided",
exact = FALSE, correct = FALSE,
nsim_est = 100000, nsim_pow = 5000, ...) {
beta <- 1-power
# p1 p2 p3
if (!is.null(pilot_x) && !is.null(pilot_y)) {
# Estimate from pilot data
probs_source <- "pilot data"
probs <- estimate_p123_data(pilot_x, pilot_y)
if (is.null(p1)) p1 <- probs$p1
if (is.null(p2)) p2 <- probs$p2
if (is.null(p3)) p3 <- probs$p3
} else if (is.null(p1) || is.null(p2) || is.null(p3)) {
# Estimate missing values from simulation
probs_source <- "simulation"
probs <- estimate_p123(theta, rdist, nsim = nsim_est)
if (is.null(p1)) p1 <- probs$p1
if (is.null(p2)) p2 <- probs$p2
if (is.null(p3)) p3 <- probs$p3
} else {
# All three provided by user
probs_source <- "user-specified"
}
# Sample Sizes
# Trial Size returns n2
n2_ts <- ceiling(Nonpara.Two.Sample(alpha, beta, k,p1,p2,p3))
n1_ts <- ceiling(k * n2_ts)
# Noether: returns N
N_no <- noether_N(alpha, beta, p1, k)
rho <- k/(k+1)
n1_no <- round(N_no * rho)
n2_no <- N_no - n1_no
# Power Simulation
power_ts <- wilcox_power(n1_ts, n2_ts, theta, alpha, rdist, nsim_pow,
alternative = alternative,
exact = exact, correct = correct)
power_no <- wilcox_power(n1_no, n2_no, theta, alpha, rdist, nsim_pow,
alternative = alternative,
exact = exact, correct = correct)
## Result Object
result <- list(
trialsize = list(n1 = n1_ts, n2=n2_ts,
N_total = n1_ts+n2_ts, power = power_ts),
noether = list(n1 = n1_no, n2=n2_no,
N_total = N_no, power = power_no),
theta = theta, alpha = alpha, target_power = power, k=k,
p1=p1, p2=p2, p3=p3,
rdist = rdist,
alternative = alternative, exact = exact, correct = correct
)
class(result) <- "wpower"
return(result)
}
wilcoxpower(theta=0.7, dist=rlogis)
wpower(theta=0.7, dist=rlogis)
estimate_p123_best <- function(theta, rdist, nsim = 30000) {
#P1
x <- rdist(nsim)
y <- rdist(nsim) + theta
p1 <- mean(y  > x)
#P2 = P(Y > X1 and Y > X2)
#
x1 <- rdist(nsim)
x2 <- rdist(nsim)
Y <- rdist(nsim) + theta
p2 <- mean((Y  > x1) & (Y  > x2))
#P3
y1 <- rdist(nsim) + theta
y2 <- rdist(nsim) + theta
X <-  rdist(nsim)
p3 <- mean((y1 > X)  & (y2 > X))
list(p1 = p1, p2 = p2, p3 = p3)
}
##############################################################
# ESTIMATION OF p1, p2, p3
##############################################################
#' Estimate p1, p2, p3 from a location shift model via simulation
#'
#'
#' p1 = P(Y >= X)
#' p2 = P(Y >= X1 AND Y >= X2)
#' p3 = P(Y1 >= X AND Y2 >= X)
#'
#'
#' @param theta Numeric Treatment Effect. Location Shift
#' @param rdist Function. Default: rnorm
#' @param nsim Number of simulation
#' @return A list with p1, p2, p3
#'
#'
estimate_p123_best <- function(theta, rdist, nsim = 30000) {
#P1
x <- rdist(nsim)
y <- rdist(nsim) + theta
p1 <- mean(y  > x)
#P2 = P(Y > X1 and Y > X2)
#
x1 <- rdist(nsim)
x2 <- rdist(nsim)
Y <- rdist(nsim) + theta
p2 <- mean((Y  > x1) & (Y  > x2))
#P3
y1 <- rdist(nsim) + theta
y2 <- rdist(nsim) + theta
X <-  rdist(nsim)
p3 <- mean((y1 > X)  & (y2 > X))
list(p1 = p1, p2 = p2, p3 = p3)
}
###########################################################
#' Estimate p1, p2, p3 from pilot data
#'
#' Given observed data from two groups, estimates p1, p2, p3 using
#' pairwise comparisons. This follows estimators described on page 363 of
#' T=Book
#'
#'
#'
#' @param x Numeric Vector. Control group observations
#' @param y Numeric vector. Treatment group observations
#' @return A list with p1, p2, p3
estimate_p123_data <- function(x, y) {
n1 <- length(x)
n2 <- length(y)
A <- rowSums(outer(y,x, ">="))
B <- colSums(outer(y,x, ">="))
p1 <- mean(outer(y, x, ">="))
p2 <- sum(A *(A-1))/ (n1 * n2 *(n1-1))
p3 <- sum(B *(B-1))/ (n1 * n2 *(n2-1))
list(p1 = p1, p2 = p2, p3 = p3)
}
##################################################
# SAMPLE SIZE NOETHER
##################################################
#' Noether (1987) sample size formula
#'
#' simpler only needs p1
#' @param alpha significance level
#' @param beta Type II error (1-Power)
#' @param p1
#' @return Total Sample Size N
#'
#'
noether_N <- function(alpha, beta, p1, k = 1) {
rho <- k / (k + 1)
z_a <- qnorm(1 - alpha/2)
z_b <- qnorm(1 - beta)
N <- (z_a + z_b)^2 / (12 * rho * (1 - rho) * (p1 - 0.5)^2)
ceiling(N)
}
##############################################################
# POWER SIMULATION
##############################################################
#' Simulate power of the Wilcoxon rank-sum test
#'
#'
#'
#' @param n1 Integer. Sample size for group 1
#' @param n2 Integer. Sample size for group 2
#' @param thera Numeric. Location Shift
#' @param alpha Numeric Significance level Default: 0.05
#' @param rdist Default: rnorm
#' @param nsim Integer. Number of simulation replicates Default
#' @param alternative Character Type of alternative hypothesis
#' one if "two.sided", "less", "greater". Default: two.sided
#' @param exact logical Compuyer exact p-value. Default: FALSE
#' @param correct Logical. Whether to apply continuity correction.
#' Default: FALSE
#'
#'
#' @return Numeric, Estimated Power
#'
#'
wilcox_power <- function(n1,n2,theta,alpha=0.05, rdist=rnorm, nsim=2000,
alternative = "two.sided",exact = FALSE,
correct = FALSE){
# Power Simulation
rejections <- replicate(nsim, {
x <- rdist(n1)
y <- theta + rdist(n2)
p_val <- stats::wilcox.test(x, y,
alternative = alternative,
exact = exact,
correct = correct)$p.value
p_val < alpha
})
mean(rejections)}
#####################################################################
# MAIN FUNCTION
#####################################################################
wpower <- function(theta, alpha = 0.05, power = 0.80, k = 1,
p1 = NULL, p2 = NULL, p3 = NULL,
rdist = rnorm,
pilot_x = NULL, pilot_y = NULL,
alternative = "two.sided",
exact = FALSE, correct = FALSE,
nsim_est = 100000, nsim_pow = 5000, ...) {
beta <- 1-power
# p1 p2 p3
if (!is.null(pilot_x) && !is.null(pilot_y)) {
# Estimate from pilot data
probs_source <- "pilot data"
probs <- estimate_p123_data(pilot_x, pilot_y)
if (is.null(p1)) p1 <- probs$p1
if (is.null(p2)) p2 <- probs$p2
if (is.null(p3)) p3 <- probs$p3
} else if (is.null(p1) || is.null(p2) || is.null(p3)) {
# Estimate missing values from simulation
probs_source <- "simulation"
probs <- estimate_p123(theta, rdist, nsim = nsim_est)
if (is.null(p1)) p1 <- probs$p1
if (is.null(p2)) p2 <- probs$p2
if (is.null(p3)) p3 <- probs$p3
} else {
# All three provided by user
probs_source <- "user-specified"
}
# Sample Sizes
# Trial Size returns n2
n2_ts <- ceiling(Nonpara.Two.Sample(alpha, beta, k,p1,p2,p3))
n1_ts <- ceiling(k * n2_ts)
# Noether: returns N
N_no <- noether_N(alpha, beta, p1, k)
rho <- k/(k+1)
n1_no <- round(N_no * rho)
n2_no <- N_no - n1_no
# Power Simulation
power_ts <- wilcox_power(n1_ts, n2_ts, theta, alpha, rdist, nsim_pow,
alternative = alternative,
exact = exact, correct = correct)
power_no <- wilcox_power(n1_no, n2_no, theta, alpha, rdist, nsim_pow,
alternative = alternative,
exact = exact, correct = correct)
## Result Object
result <- list(
trialsize = list(n1 = n1_ts, n2=n2_ts,
N_total = n1_ts+n2_ts, power = power_ts),
noether = list(n1 = n1_no, n2=n2_no,
N_total = N_no, power = power_no),
theta = theta, alpha = alpha, target_power = power, k=k,
p1=p1, p2=p2, p3=p3,
rdist = rdist,
alternative = alternative, exact = exact, correct = correct
)
class(result) <- "wpower"
return(result)
}
wpower(theta=0.7, dist=rlogis)
wpower(theta=0.7, rdist=rlogis)
wpoer(theta=0.7)
wpower(theta=0.7)
getAnywhere(wpower)
devtools::load_all()
wpower(theta = 0.7)
wpower(theta = 0.7)
library(clinsim)
"clinsim" %in% installed.packages()[, "Package"]
devtools::load_all()
library(TrialSize)
devtools::load_all()
rlang::last_trace()
devtools::load_all()
wpower(theta = 0.7)
devtools::load_all()
wpower(theta = 0.7)
test <- wpower(theta = 0.7)
print.wpower(test)
summary.wpower(test)
plot.wpower(test)
################################################################################
# power_curve.R
#
# Convenience function for generating power curves across a range of
# theta values, comparing Noether and TrialSize methods.
################################################################################
#' Plot power curves across a range of effect sizes
#'
#' Runs wilcox_sample_size() for each value of theta and produces two plots:
#' simulated power vs theta, and total sample size vs theta, for both methods.
#'
#' @param theta_range Numeric vector. Values of theta to evaluate.
#' @param alpha Numeric. Significance level. Default: 0.05.
#' @param power Numeric. Target power. Default: 0.80.
#' @param k Numeric. Allocation ratio n1/n2. Default: 1.
#' @param rdist Function. Random number generator for errors. Default: rnorm.
#' @param alternative Character. Alternative hypothesis. Default: "two.sided".
#' @param exact Logical. Exact p-value. Default: FALSE.
#' @param correct Logical. Continuity correction. Default: FALSE.
#' @param nsim_est Integer. Replicates for estimation. Default: 100000.
#' @param nsim_pow Integer. Replicates for power simulation. Default: 5000.
#' @return A data frame with results for each theta (invisibly).
#'
#' @examples
#' # Power curves for normal errors
#' results <- plot_power_curve(theta_range = seq(0.3, 1.2, by = 0.1))
#'
#' # Power curves for logistic errors
#' results <- plot_power_curve(theta_range = seq(0.3, 1.2, by = 0.1),
#'                             rdist = rlogis)
#' @export
plot_power_curve <- function(theta_range, alpha = 0.05, power = 0.80,
k = 1, rdist = rnorm,
alternative = "two.sided",
exact = FALSE, correct = FALSE,
nsim_est = 100000, nsim_pow = 5000) {
# Storage
results <- data.frame(
theta = numeric(),
p1 = numeric(), p2 = numeric(), p3 = numeric(),
N_noether = numeric(), power_noether = numeric(),
N_trialsize = numeric(), power_trialsize = numeric()
)
# Run for each theta
for (th in theta_range) {
cat(sprintf("Running theta = %.2f ...\n", th))
res <- wilcox_sample_size(theta = th, alpha = alpha, power = power,
k = k, rdist = rdist,
alternative = alternative,
exact = exact, correct = correct,
nsim_est = nsim_est, nsim_pow = nsim_pow)
results <- rbind(results, data.frame(
theta = th,
p1 = res$p1, p2 = res$p2, p3 = res$p3,
N_noether = res$noether$N_total,
power_noether = res$noether$power,
N_trialsize = res$trialsize$N_total,
power_trialsize = res$trialsize$power
))
}
# Plot
oldpar <- par(mfrow = c(1, 2), mar = c(5, 4, 3, 1))
on.exit(par(oldpar))
# Power curves
plot(results$theta, results$power_noether, type = "b", pch = 16,
col = "steelblue", ylim = c(0, 1),
xlab = expression(theta), ylab = "Simulated Power",
main = "Power vs Effect Size")
lines(results$theta, results$power_trialsize, type = "b", pch = 17,
col = "coral")
abline(h = power, lty = 2, col = "grey40")
legend("bottomright", legend = c("Noether", "TrialSize"),
col = c("steelblue", "coral"), pch = c(16, 17), lty = 1)
# Sample size curves
plot(results$theta, results$N_noether, type = "b", pch = 16,
col = "steelblue",
xlab = expression(theta), ylab = "Total N",
main = "Sample Size vs Effect Size")
lines(results$theta, results$N_trialsize, type = "b", pch = 17,
col = "coral")
legend("topright", legend = c("Noether", "TrialSize"),
col = c("steelblue", "coral"), pch = c(16, 17), lty = 1)
cat("\nDone.\n")
invisible(results)
}
results <- plot_power_curve(theta_range = seq(0.3, 1.2, by = 0.1))
plot_power_curve <- function(theta_range, alpha = 0.05, power = 0.80,
k = 1, rdist = rnorm,
alternative = "two.sided",
exact = FALSE, correct = FALSE,
nsim_est = 100000, nsim_pow = 5000) {
# Storage
results <- data.frame(
theta = numeric(),
p1 = numeric(), p2 = numeric(), p3 = numeric(),
N_noether = numeric(), power_noether = numeric(),
N_trialsize = numeric(), power_trialsize = numeric()
)
# Run for each theta
for (th in theta_range) {
cat(sprintf("Running theta = %.2f ...\n", th))
res <- wpower(theta = th, alpha = alpha, power = power,
k = k, rdist = rdist,
alternative = alternative,
exact = exact, correct = correct,
nsim_est = nsim_est, nsim_pow = nsim_pow)
results <- rbind(results, data.frame(
theta = th,
p1 = res$p1, p2 = res$p2, p3 = res$p3,
N_noether = res$noether$N_total,
power_noether = res$noether$power,
N_trialsize = res$trialsize$N_total,
power_trialsize = res$trialsize$power
))
}
# Plot
oldpar <- par(mfrow = c(1, 2), mar = c(5, 4, 3, 1))
on.exit(par(oldpar))
# Power curves
plot(results$theta, results$power_noether, type = "b", pch = 16,
col = "steelblue", ylim = c(0, 1),
xlab = expression(theta), ylab = "Simulated Power",
main = "Power vs Effect Size")
lines(results$theta, results$power_trialsize, type = "b", pch = 17,
col = "coral")
abline(h = power, lty = 2, col = "grey40")
legend("bottomright", legend = c("Noether", "TrialSize"),
col = c("steelblue", "coral"), pch = c(16, 17), lty = 1)
# Sample size curves
plot(results$theta, results$N_noether, type = "b", pch = 16,
col = "steelblue",
xlab = expression(theta), ylab = "Total N",
main = "Sample Size vs Effect Size")
lines(results$theta, results$N_trialsize, type = "b", pch = 17,
col = "coral")
legend("topright", legend = c("Noether", "TrialSize"),
col = c("steelblue", "coral"), pch = c(16, 17), lty = 1)
cat("\nDone.\n")
invisible(results)
}
results <- plot_power_curve(theta_range = seq(0.3, 1.2, by = 0.1))
devtools::load_all()
wpower(theta=0.7)
test <- wpower(theta=0.8)
print.wpower(test)
summary.wpower(test)
devtools::load_all()
summary.wpower(test)
results2 <- plot_power_curve(theta_range = c(0.4, 0.6, 0.8, 1.0, 1.2),nsim_pow=3000)
print.wpower(test)
################################################################################
# power_curve.R
#
#  generating power curves across a range of
# theta values, comparing Noether and TrialSize methods.
################################################################################
#' Plot power curves across a range of effect sizes
#'
plot_power_curve <- function(theta_range, alpha = 0.05, power = 0.80,
k = 1, rdist = rnorm,
alternative = "two.sided",
exact = FALSE, correct = FALSE,
nsim_est = 100000, nsim_pow = 5000) {
results <- data.frame(
theta = numeric(),
p1 = numeric(), p2 = numeric(), p3 = numeric(),
N_noether = numeric(), power_noether = numeric(),
N_trialsize = numeric(), power_trialsize = numeric()
)
# Run for each theta
for (th in theta_range) {
res <- wpower(theta = th, alpha = alpha, power = power,
k = k, rdist = rdist,
alternative = alternative,
exact = exact, correct = correct,
nsim_est = nsim_est, nsim_pow = nsim_pow)
results <- rbind(results, data.frame(
theta = th,
p1 = res$p1, p2 = res$p2, p3 = res$p3,
N_noether = res$noether$N_total,
power_noether = res$noether$power,
N_trialsize = res$trialsize$N_total,
power_trialsize = res$trialsize$power
))
}
# Plot
oldpar <- par(mfrow = c(1, 2), mar = c(5, 4, 3, 1))
on.exit(par(oldpar))
# Power curves
plot(results$theta, results$power_noether, type = "b", pch = 16,
col = "navy", ylim = c(0, 1),
xlab = expression(theta), ylab = "Simulated Power",
main = "Power vs Effect Size")
lines(results$theta, results$power_trialsize, type = "b", pch = 17,
col = "magenta")
abline(h = power, lty = 2, col = "red")
legend("bottomright", legend = c("Noether", "TrialSize"),
col = c("navy", "magenta"), pch = c(16, 17), lty = 1)
# Sample size curves
plot(results$theta, results$N_noether, type = "b", pch = 16,
col = "navy",
xlab = expression(theta), ylab = "Total N",
main = "Sample Size vs Effect Size")
lines(results$theta, results$N_trialsize, type = "b", pch = 17,
col = "magenta")
legend("topright", legend = c("Noether", "TrialSize"),
col = c("navy", "magenta"), pch = c(16, 17), lty = 1)
invisible(results)
}
results2 <- plot_power_curve(theta_range = c(0.4, 0.6, 0.8, 1.0, 1.2),nsim_pow=3000)
print.wpower <- function(x,...){
cat("Wilcoxon-Mann-Whitney Sample Size/Power Calculation\n")
cat("Call: ")
print(x$call)
cat("\n")
cat(sprintf("  theta = %.3f | alpha = %.3f | target power = %.2f | k = %.1f\n",
x$theta, x$alpha, x$target_power, x$k))
cat(sprintf("  Noether:    n1 = %d, n2 = %d, total = %d, power = %.3f\n",
x$noether$n1, x$noether$n2, x$noether$N_total, x$noether$power))
cat(sprintf("  TrialSize:  n1 = %d, n2 = %d, total = %d, power = %.3f\n",
x$trialsize$n1, x$trialsize$n2, x$trialsize$N_total, x$trialsize$power))
x
}
print.wpower(test)
print.wpower <- function(x,...){
cat("Wilcoxon-Mann-Whitney Sample Size/Power Calculation\n")
cat("Call: ")
print(x$call)
cat("\n")
cat(sprintf("  theta = %.3f | alpha = %.3f | target power = %.2f | k = %.1f\n",
x$theta, x$alpha, x$target_power, x$k))
cat(sprintf("  Noether:    n1 = %d, n2 = %d, total = %d, power = %.3f\n",
x$noether$n1, x$noether$n2, x$noether$N_total, x$noether$power))
cat(sprintf("  TrialSize:  n1 = %d, n2 = %d, total = %d, power = %.3f\n",
x$trialsize$n1, x$trialsize$n2, x$trialsize$N_total, x$trialsize$power))
invisible(x)
}
print.wpower(test)
